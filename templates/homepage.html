<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Virtual Systems Lab - Remote Experiments</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ----------------------------------------------------- */
        /* 1. VIBRANT TECH BASE STYLES */
        /* ----------------------------------------------------- */
        :root {
            --color-white: #ffffff;
            --color-bg-light: #f8f9fa; 
            --color-primary: #00C4FF; /* Electric Blue/Cyan - Main Accent */
            --color-secondary: #484c7f; /* Deep Grey-Blue for Dark Text */
            --color-text-dark: #212529;
            --color-text-subtle: #6c757d;
            --color-border: #e9ecef;
            --color-success: #2ecc71; /* Green for success states */
        }
        body { 
            font-family: 'Inter', Arial, sans-serif; 
            margin: 0; 
            color: var(--color-text-dark); 
            min-height: 100vh;
            background-color: var(--color-bg-light); 
        }
        
        /* HEADER (Sticky and Clean) */
        .header { 
            background: var(--color-white); 
            padding: 15px 50px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0;
            z-index: 1000;
        }
        .header h1 { 
            font-size: 1.6em; 
            font-weight: 800; 
            color: var(--color-secondary);
        }
        .header h1 i {
            color: var(--color-primary);
            margin-right: 10px;
        }
        .booking-widget { 
            background: var(--color-primary); 
            color: var(--color-white);
            padding: 10px 25px; 
            border-radius: 50px; /* Pill shape */
            font-weight: 500; 
            font-size: 0.7em; 
            box-shadow: 0 4px 15px rgba(0, 196, 255, 0.5);
            transition: background 0.3s;
        }
        .booking-widget:hover {
            background: #0099CC;
        }
        
        /* MAIN CONTAINER & SECTION TITLES */
        .container { 
            max-width: 1300px;
            margin: 0 auto; 
            padding: 0 40px; 
            padding-top: 50px; 
            padding-bottom: 20px;
        }
        h2 { 
            color: var(--color-text-dark); 
            font-weight: 600; 
            font-size: 1.5em;
            margin-top: 50px; 
            margin-bottom: 30px;
            border-left: 5px solid var(--color-primary); /* Visual emphasis */
            padding-left: 20px;
        }
        h2 i {
            color: var(--color-primary);
            margin-right: 15px;
        }

        /* Hero Section (New, attractive element) */
        .hero-section {
            background: linear-gradient(135deg, var(--color-secondary), #1e203a);
            color: var(--color-white);
            padding: 50px 30px;
            border-radius: 15px;
            margin-bottom: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hero-content h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin: 0 0 15px 0;
            line-height: 1.1;
        }
        .hero-content p {
            font-size: 1.2em;
            font-weight: 400;
            color: #d0d2ff;
            max-width: 700px;
            margin-bottom: 30px;
        }
        .hero-cta {
            background: var(--color-primary);
            color: var(--color-secondary); /* Dark text on bright button */
            padding: 15px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 700;
            font-size: 1.1em;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .hero-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 196, 255, 0.6);
        }
        .hero-icon {
            font-size: 6em;
            color: var(--color-primary);
            opacity: 0.8;
            margin-left: 50px;
        }
        
        /* Auth Bar */
        .auth-bar { 
            text-align: right; 
            padding: 10px 50px; 
            background: var(--color-white); 
            border-bottom: 1px solid var(--color-border);
        }
        .auth-bar button {
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 700;
            transition: transform 0.2s, background 0.2s;
            margin-left: 10px;
        }
        .auth-bar button:hover {
            transform: translateY(-1px);
        }
        #loginBtn { background: var(--color-secondary); color: var(--color-white); }
        #logoutBtn { background: #dc3545; color: white; }

        /* ----------------------------------------------------- */
        /* 2. INFO SECTION (Features) */
        /* ----------------------------------------------------- */
        .info-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .support-card { 
            background: var(--color-white); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border-bottom: 4px solid var(--color-primary); /* Primary color line */
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .support-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        .support-card h3 {
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--color-secondary);
            font-weight: 800;
        }
        .support-card i {
            font-size: 3em;
            color: var(--color-primary);
            margin-bottom: 10px;
            display: block;
            background: #e6f7ff; /* Light background for icon */
            width: 60px;
            height: 60px;
            line-height: 60px;
            text-align: center;
            border-radius: 8px;
        }
        .support-card p { font-size: 1.0em; line-height: 1.6; color: var(--color-text-subtle); }

        /* ----------------------------------------------------- */
        /* 3. CARD STYLES (Experiments) - Dynamic Grid */
        /* ----------------------------------------------------- */
        .experiments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .experiment-card { 
            background: var(--color-white); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.08); 
            border: 1px solid var(--color-border); 
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .experiment-card:hover { 
            box-shadow: 0 12px 35px rgba(0,0,0,0.15); 
            transform: translateY(-5px); 
            border-color: var(--color-primary);
        }
        .exp-title h3 { 
            margin: 0; 
            color: var(--color-secondary); 
            font-weight: 600; 
            /* REDUCED FONT SIZE for experiment titles */
            font-size: 1.2em; 
            margin-bottom: 5px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-border);
        }
        .exp-title .sop { 
            margin: 15px 0 0 0; 
            /* REDUCED FONT SIZE for SOP description */
            font-size: 0.9em; 
            color: var(--color-text-subtle); 
            line-height: 1.5; 
        }
        .price-structure { 
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed var(--color-border);
            font-size: 0.9em; 
            line-height: 1.6; 
            color: var(--color-text-subtle);
        }
        
        /* Booking Button */
        .book-btn { 
            /* REDUCED VERTICAL PADDING */
            padding: 12px 30px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            background: var(--color-primary); 
            color: var(--color-secondary); 
            /* REDUCED FONT SIZE & WEIGHT for button text */
            font-size: 0.95em; 
            font-weight: 700; 
            transition: background 0.3s, transform 0.2s; 
            margin-top: 25px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0, 196, 255, 0.4);
        }
        .book-btn:hover { 
            background: #0099CC; 
            transform: translateY(-2px);
            color: var(--color-white);
        }
        .book-btn.primary {
            background: var(--color-success) !important;
            color: var(--color-white) !important;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4) !important;
        }
        .book-btn.primary:hover {
            background: #27ae60 !important;
        }
        
        /* ----------------------------------------------------- */
        /* 4. UTILITY / CONTACT STYLES */
        /* ----------------------------------------------------- */
        .contact-card {
            background: var(--color-white);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .contact-card h2 {
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 20px;
            border-left: none;
            padding-left: 0;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 10px;
            color: var(--color-secondary);
            font-weight: 800;
        }
        .contact-card h2 i {
            color: var(--color-primary);
        }
        .contact-card p {
            margin: 10px 0;
            color: var(--color-text-dark);
            font-size: 0.8em;
        }
        .contact-card i.fa-phone, .contact-card i.fa-envelope, .contact-card i.fa-map-marker-alt {
            color: var(--color-primary);
            margin-right: 10px;
        }
        code {
            color: var(--color-primary);
            background: var(--color-border);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* ----------------------------------------------------- */
        /* 5. MODAL STYLES (Clean and Primary Color Focused) */
        /* ----------------------------------------------------- */
        .modal {
             display: none; 
             position: fixed; 
             z-index: 1001; 
             left: 0; 
             top: 0; 
             width: 100%; 
             height: 100%; 
             overflow: auto; 
             background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: var(--color-white);
            margin: 5% auto; 
            padding: 40px;
            border: 5px solid var(--color-primary);
            width: 90%; 
            max-width: 450px;
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
        }
        .modal-content h3 {
            color: var(--color-secondary);
            margin-top: 0;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 10px;
            font-size: 1.8em;
            font-weight: 800;
        }
        .close-btn { color: #888; float: right; font-size: 32px; font-weight: bold;}
        .close-btn:hover, .close-btn:focus { color: var(--color-primary); }
        .modal-content label {
            display: block;
            margin-top: 15px;
            font-weight: 700;
            color: var(--color-text-dark);
            font-size: 0.95em;
        }
        .modal-content input, .modal-content select {
            width: 95%;
            padding: 12px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: var(--color-bg-light); 
            color: var(--color-text-dark);
        }
        
        /* Booking Status */
        .booking-item {
            padding: 20px; 
            margin-bottom: 15px; 
            background: var(--color-white);
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 6px solid var(--color-primary);
        }
        .booking-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .booking-actions button {
            margin-left: 10px;
            font-size: 0.9em;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 700;
        }

        .booking-status-text {
            margin-top: 8px; 
            font-weight: 700;
            font-size: 0.9em;
        }

        .status-upcoming { color: var(--color-primary); }
        .status-active { color: var(--color-success); }
        .status-inprogress { color: #f1c40f; }
        .status-completed, .status-expired, .status-cancelled { color: var(--color-text-subtle); }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-microchip"></i> Remote Lab</h1>
        <div class="">
            
        </div>
    </div>

    <div class="auth-bar">
        <button id="loginBtn" onclick="openAuthModal()">
            Login / Signup <i class="fas fa-sign-in-alt"></i>
        </button>

        <button id="logoutBtn" onclick="logoutUser()" style="display:none;">
            Logout <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>

    <div class="container">
        <div class="hero-section">
            <div class="hero-content">
                <h1>Remote System <span style="color:var(--color-primary);">Lab Access</span>.</h1>
                <p>Gain real-time, remote control over physical hardware experiments. Ideal for students, researchers, and professional skill development in IoT and Embedded C.</p>
                <a href="#experiments" class="hero-cta">
                    View Experiments <i class="fas fa-arrow-circle-right"></i>
                </a>
            </div>
            <div class="hero-icon">
                <i class="fas fa-flask"></i>
            </div>
        </div>
    </div>

    <div id="myBookings" class="container" style="display:none; padding-top:20px;">
        <h2><i class="fas fa-calendar-alt"></i> My Booked Slots</h2>
        <div id="bookingsList" style="font-size:1em; color:var(--color-text-dark);"></div>
    </div>

    <div class="container">
        
        <h2>Why Choose Remote lab?</h2>
        <div class="info-section">
            <div class="support-card">
                <i class="fas fa-rocket"></i>
                <h3>Unmatched Remote Control</h3>
                <p>Get exclusive, real-time control of a dedicated hardware setup dedicated micro-controller and peripherals — all operated remotely from your location. Watch and interact through a live camera feed, just as if the device were right on your desk.</p>
            </div>
            <div class="support-card">
                <i class="fas fa-code-branch"></i>
                <h3>Full Control & Flexibility</h3>
                <p>Upload your own compiled `.bin/.hex/.out` files and debug your code in a realistic environment. We give you the flexibility to go beyond simple commands and enjoy the freedom to experiment, ideal for research, education, and skill development.</p>
            </div>
            <div class="support-card">
                <i class="fas fa-award"></i>
                <h3>Secure & Reliable</h3>
                <p>Session-based security ensures your experiment is fully isolated. Reliable scheduling means guaranteed access during your booked window. Learn with confidence.</p>
            </div>
        </div>

        <h2 id="experiments"><i class="fas fa-flask"></i> Available Experiments</h2>
        <div class="experiments-grid">
            
            <div class="experiment-card">
                <div class="card-top">
                    <div class="exp-title">
                        <h3>1. DC Motor Speed Control</h3>
                    </div>
                    <p class="sop">SOP Summary: Control DC motor speed using PWM with real-time RPM feedback.
Ensure stable, precise, and reliable motor performance. .</p>
                    <div class="price-structure">
                        (Max 60 min session | Recommended for Embedded C fundamentals)
                    </div>
                </div>
                <button class="book-btn" onclick="openBookingModal('DC Motor', 'DC Motor Speed Control')">
                    Book Your Slot Now <i class="fas fa-calendar-check"></i>
                </button>
            </div>

            <div class="experiment-card">
                <div class="card-top">
                    <div class="exp-title">
                        <h3>2. Temperature & Humidity Monitoring</h3>
                    </div>
                    <p class="sop">SOP Summary: Interface with a DHT sensor, read environmental data, and log / visualize the readings on a real-time data chart.</p>
                    <div class="price-structure">
                        (Max 60 min session | Focus on sensor interfacing and data handling)
                    </div>
                </div>
                <button class="book-btn" onclick="openBookingModal('TEMP_HUMIDITY', 'Temperature & Humidity Monitoring')">
                    Book Your Slot Now <i class="fas fa-calendar-check"></i>
                </button>
            </div>

            <div class="experiment-card">
                <div class="card-top">
                    <div class="exp-title">
                        <h3>3. Stepper Motor Control</h3>
                    </div>
                    <p class="sop">SOP Summary: Implement precise sequence control logic to manage angular rotation, speed, and direction of a stepper motor.</p>
                    <div class="price-structure">
                        (Max 60 min session | Test advanced timing and control algorithms)
                    </div>
                </div>
                <button class="book-btn" onclick="openBookingModal('STEPPER_MOTOR', 'Stepper Motor Control')">
                    Book Your Slot Now <i class="fas fa-calendar-check"></i>
                </button>
            </div>
        </div>
        
        <div class="info-section" style="margin-top: 80px;">
            <div class="contact-card" style="flex: 2;">
                <h2><i class="fas fa-clipboard-list"></i> Session Rules & Protocol</h2>
            
                <p>The lab interface provides terminal access for commands and a secure method for **firmware flashing**. Any attempt to bypass security or perform unauthorized actions will result in immediate session termination.</p>
                <p><strong>Support:</strong> For urgent technical issues during a session, please call the support line immediately. <i class="fas fa-phone" style="color:var(--color-success)"></i></p>
            </div>
            <div class="contact-card" style="flex: 1;">
                <h2><i class="fas fa-headset"></i> Contact Us</h2>
                <p><strong>Technical Helpline:</strong> <i class="fas fa-phone"></i> +91-9620122867</p>
                <p><strong>Email Support:</strong> <i class="fas fa-envelope"></i> support@vlab.edu</p>
                <p><strong>Address:</strong> <i class="fas fa-map-marker-alt"></i> Remote lab DESE, Bangalore, India.</p>
            </div>
        </div>

    </div>

    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>Book Your Session Slot</h3>
        <p id="modalExpTitle" style="color:var(--color-primary); font-weight:800;"></p>
        <form id="bookingForm">
            <input type="hidden" id="expIdInput" name="experimentId">

            <label for="userName">Full Name</label>
            <input type="text" id="userName" name="userName" required>

            <label for="userEmail">Email ID (for notification)</label>
            <input type="email" id="userEmail" name="userEmail" required>
            
            <label for="slotDate">Session Date</label>
            <input type="date" id="slotDate" name="slotDate" required>
            
            <label for="slotTime">Session Start Time</label>
            <input type="time" id="slotTime" name="slotTime" required>

            <label for="duration">Duration (Max 60 minutes)</label>
            <select id="duration" name="duration" required>
                <option value="1">1 minutes</option>
                <option value="2" selected>2 minutes</option>
                <option value="45">30 minutes</option>
                <option value="60">60 minutes</option>
            </select>
            
            <button type="submit" class="book-btn primary">
                Confirm Booking <i class="fas fa-check-circle"></i>
            </button>
        </form>
      </div>
    </div>

    <div id="authModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeAuthModal()">&times;</span>
        <h3>User Login / Signup</h3>

        <label>Email</label>
        <input type="email" id="authEmail" placeholder="you@example.com">

        <label>Password</label>
        <input type="password" id="authPassword" placeholder="Choose a password">

        <button onclick="loginOrSignup()" class="book-btn" style="width:100%; margin-top:20px;">
            Continue <i class="fas fa-user-circle"></i>
        </button>
      </div>
    </div>

    <script>
        /******************************
         * Configuration
         ******************************/
        const PI_EXPERIMENT_URL = "/experiment"; // Local experiment base URL
        const STATUS = {
            UPCOMING: 'UPCOMING',
            ACTIVE: 'ACTIVE',         // time window has arrived (user can start)
            IN_PROGRESS: 'IN_PROGRESS',
            COMPLETED: 'COMPLETED',
            EXPIRED: 'EXPIRED',
            CANCELLED: 'CANCELLED'
        };

        /******************************
         * Utility: Random 8-char key
         ******************************/
        function generateSessionKey() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let out = "";
            for (let i = 0; i < 8; i++) {
                out += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return out;
        }

        /******************************
         * Auth modal functions (localStorage)
         ******************************/
        function openAuthModal() {
            document.getElementById("authModal").style.display = "block";
        }
        function closeAuthModal() {
            document.getElementById("authModal").style.display = "none";
        }

        function loginOrSignup() {
            const email = document.getElementById("authEmail").value.trim().toLowerCase();
            const pass  = document.getElementById("authPassword").value;

            if (!email || !pass) {
                alert("Please enter email and password.");
                return;
            }

            let users = JSON.parse(localStorage.getItem("users") || "{}");

            if (!users[email]) {
                // Signup
                users[email] = { password: pass };
                localStorage.setItem("users", JSON.stringify(users));
                alert("Account created and logged in.");
            } else {
                // Login
                if (users[email].password !== pass) {
                    alert("Incorrect password.");
                    return;
                }
                alert("Logged in successfully.");
            }

            localStorage.setItem("loggedUser", email);
            closeAuthModal();
            updateAuthUI();
        }

        function logoutUser() {
            localStorage.removeItem("loggedUser");
            updateAuthUI();
        }

        function updateAuthUI() {
            const user = localStorage.getItem("loggedUser");
            document.getElementById("loginBtn").style.display  = user ? "none" : "inline-block";
            document.getElementById("logoutBtn").style.display = user ? "inline-block" : "none";
            loadMyBookings();
        }

        /******************************
         * Booking modal & logic
         ******************************/
        const modal = document.getElementById("bookingModal");
        const expIdInput = document.getElementById("expIdInput");
        const modalExpTitle = document.getElementById("modalExpTitle");
        const bookingForm = document.getElementById("bookingForm");

        function openBookingModal(experimentId, title) {
            const user = localStorage.getItem("loggedUser");
            if (!user) {
                alert("Please login to book a slot.");
                openAuthModal();
                return;
            }

            expIdInput.value = experimentId;
            modalExpTitle.textContent = title;
            // Pre-fill email field when modal opens
            const emailInput = document.getElementById("userEmail");
            if (emailInput) emailInput.value = user;
            
            modal.style.display = "block";
        }

        function closeModal() {
            modal.style.display = "none";
        }

        // Close on outside click (for both modals)
        window.onclick = function(event) {
            if (event.target === modal) closeModal();
            if (event.target === document.getElementById("authModal")) closeAuthModal();
        };

        // Helper: parse date + time (YYYY-MM-DD & HH:MM) into timestamp (ms)
        function parseDateTime(dateStr, timeStr) {
            if (!dateStr || !timeStr) return null;
            // timeStr is 'HH:MM' 24-hour format
            const [hh, mm] = timeStr.split(':').map(n => parseInt(n, 10));
            const d = new Date(dateStr);
            d.setHours(hh, mm, 0, 0);
            return d.getTime();
        }

        // Save booking on submit — DO NOT auto-open experiment now; scheduling enforced later
        bookingForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const user = localStorage.getItem("loggedUser");
            if (!user) {
                alert("Login required to book.");
                openAuthModal();
                return;
            }

            const experimentId = document.getElementById("expIdInput").value;
            const expTitle = modalExpTitle.textContent;
            const name = document.getElementById("userName").value.trim();
            const email = document.getElementById("userEmail").value.trim();
            const slotDate = document.getElementById("slotDate").value;
            const slotTime = document.getElementById("slotTime").value;
            const duration = parseInt(document.getElementById("duration").value);

            if (!name || !email || !slotDate || !slotTime || !duration) {
                alert("Please fill all fields.");
                return;
            }

            // Validate that the chosen date/time is not in the past (small tolerance allowed)
            const slotStartMs = parseDateTime(slotDate, slotTime);
            if (slotStartMs === null) { alert("Invalid date/time"); return; }
            const now = Date.now();
            if (slotStartMs + 60*1000 < now) { 
                if (!confirm("You selected a past time. Do you still want to book?")) {
                    return;
                }
            }

            // Create booking object & session key
            const key = generateSessionKey();
            const booking = {
                id: key,
                userName: name,
                userEmail: email,
                experimentId: experimentId,
                title: expTitle,
                date: slotDate,          
                time: slotTime,          
                startMs: slotStartMs,    
                duration: duration,      
                endMs: slotStartMs + duration * 60 * 1000,
                createdAt: new Date().toISOString(),
                status: STATUS.UPCOMING,
                startedAt: null,         
                completedAt: null
            };

            let bookings = JSON.parse(localStorage.getItem("bookings") || "{}");
            if (!bookings[user]) bookings[user] = [];
            bookings[user].push(booking);
            localStorage.setItem("bookings", JSON.stringify(bookings));

            alert(`Booking saved ✅\nYour session key: ${booking.id}\nStart at: ${booking.date} ${booking.time}`);
            closeModal();
            updateAuthUI();
        });

        /******************************
         * My Booked Slots: load & actions
         ******************************/
        function loadMyBookings() {
            const user = localStorage.getItem("loggedUser");
            const container = document.getElementById("myBookings");
            const listDiv = document.getElementById("bookingsList");

            if (!user) {
                container.style.display = "none";
                return;
            }

            let bookings = JSON.parse(localStorage.getItem("bookings") || "{}");
            let list = bookings[user] || [];

            // First update statuses for each booking
            const now = Date.now();
            list = list.map(b => {
                // If already cancelled/completed, keep as is
                if (b.status === STATUS.CANCELLED || b.status === STATUS.COMPLETED) return b;

                // If started:
                if (b.startedAt) {
                    const startedAt = b.startedAt;
                    const endAfterStart = startedAt + b.duration * 60 * 1000;
                    if (now > endAfterStart) {
                        b.status = STATUS.COMPLETED;
                        b.completedAt = endAfterStart;
                    } else {
                        b.status = STATUS.IN_PROGRESS;
                    }
                    return b;
                }

                // Not started yet:
                if (now < b.startMs) {
                    b.status = STATUS.UPCOMING;
                } else if (now >= b.startMs && now <= b.endMs) {
                    b.status = STATUS.ACTIVE; // user can start now
                } else if (now > b.endMs) {
                    // window passed and user never started -> expired
                    b.status = STATUS.EXPIRED;
                }
                return b;
            });

            // Save back statuses
            bookings[user] = list;
            localStorage.setItem("bookings", JSON.stringify(bookings));

            if (list.length === 0) {
                container.style.display = "none";
                listDiv.innerHTML = "<p>You have no scheduled bookings.</p>";
                return;
            }

            container.style.display = "block";
            let html = "";

            list.forEach((b, idx) => {
                // show friendly start availability text
                let statusLabel = b.status;
                let statusText = "";
                let startButtonHtml = "";
                let deleteButtonHtml = "";
                let statusClass = "";

                const startTimeFormatted = formatDateTimeDisplay(b.startMs);
                const endTimeFormatted = formatDateTimeDisplay(b.endMs);

                if (b.status === STATUS.UPCOMING) {
                    statusText = `UPCOMING — available at ${formatTimeOnly(b.startMs)} on ${formatDateOnly(b.startMs)}`;
                    statusClass = "status-upcoming";
                    // allow delete only for upcoming
                    deleteButtonHtml = `<button onclick="deleteBooking('${user}', ${idx})" style="background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer;">Cancel</button>`;
                } else if (b.status === STATUS.ACTIVE) {
                    statusText = `START WINDOW — ${formatTimeOnly(b.startMs)} → ${formatTimeOnly(b.endMs)}`;
                    statusClass = "status-active";
                    // start button enabled
                    startButtonHtml = `<button onclick="startBooking('${user}', ${idx})" class="book-btn primary" style="display:inline-block; width:auto; margin:0; font-size:0.95em;">Start <i class="fas fa-play"></i></button>`;
                } else if (b.status === STATUS.IN_PROGRESS) {
                    // show remaining time
                    const remainingMs = Math.max(0, (b.startedAt + b.duration * 60 * 1000) - Date.now());
                    statusText = `IN PROGRESS — ends at ${formatTimeOnly(b.startedAt + b.duration*60*1000)} (Remaining: <span class="live-timer" data-session-id="${b.id}">${msToTimeShort(remainingMs)}</span>)`;
                    statusClass = "status-inprogress";
                    // no delete, but allow showing "In progress" and maybe a "Bring to experiment" button
                    startButtonHtml = `<button onclick="focusExperiment('${b.id}')" class="book-btn" style="display:inline-block; width:auto; margin:0; background:#007bff !important; color: white !important; box-shadow: none; font-size:0.95em;">Open <i class="fas fa-external-link-alt"></i></button>`;
                } else if (b.status === STATUS.COMPLETED) {
                    statusText = `COMPLETED — ${formatDateOnly(b.completedAt || b.endMs)} ${formatTimeOnly(b.completedAt || b.endMs)}`;
                    statusClass = "status-completed";
                } else if (b.status === STATUS.EXPIRED) {
                    statusText = `EXPIRED — session window passed (was ${startTimeFormatted} → ${endTimeFormatted})`;
                    statusClass = "status-expired";
                } else if (b.status === STATUS.CANCELLED) {
                    statusText = `CANCELLED`;
                    statusClass = "status-cancelled";
                }

                html += `
                    <div class="booking-item">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <i class="fas fa-tag" style="color:var(--color-primary); margin-right:5px;"></i>
                                <strong>${b.title}</strong><br>
                                <small style="color:var(--color-text-subtle);">Slot: ${formatDateOnly(b.startMs)} ${formatTimeOnly(b.startMs)} &nbsp; | &nbsp; Duration: ${b.duration} min</small>
                                <div class="booking-status-text ${statusClass}"><strong>Status:</strong> ${statusText}</div>
                                <div style="margin-top:6px; font-size:0.9em;">Session Key: <code>${b.id}</code></div>
                            </div>
                            <div class="booking-actions" style="text-align:right;">
                                ${startButtonHtml}
                                ${deleteButtonHtml}
                            </div>
                        </div>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        // Delete only allowed for UPCOMING
        function deleteBooking(user, index) {
            let bookings = JSON.parse(localStorage.getItem("bookings") || "{}");
            const b = (bookings[user] || [])[index];
            if (!b) { alert("Booking not found."); return; }
            if (b.status !== STATUS.UPCOMING) {
                alert("Only upcoming bookings can be deleted.");
                return;
            }
            if (!confirm("Delete this booking?")) return;
            bookings[user].splice(index, 1);
            localStorage.setItem("bookings", JSON.stringify(bookings));
            loadMyBookings();
        }

        // When user clicks Start: open Pi URL in new tab and set startedAt; auto-close after remaining time
        function startBooking(user, index) {
            let bookings = JSON.parse(localStorage.getItem("bookings") || "{}");
            const b = (bookings[user] || [])[index];
            if (!b) { alert("Booking not found."); return; }

            const now = Date.now();
            if (!(now >= b.startMs && now <= b.endMs)) {
                alert(`Session not available now. Allowed window: ${formatTimeOnly(b.startMs)} → ${formatTimeOnly(b.endMs)}`);
                loadMyBookings();
                return;
            }

            // mark startedAt if not already
            if (!b.startedAt) {
                b.startedAt = now;
            }
            b.status = STATUS.IN_PROGRESS;
            bookings[user][index] = b;
            localStorage.setItem("bookings", JSON.stringify(bookings));

            // Store session info for shared timer
            const sessionEndTime = b.startedAt + b.duration * 60 * 1000;
            localStorage.setItem('sessionEndTime_' + b.id, sessionEndTime);
            localStorage.setItem('sessionStatus_' + b.id, 'IN_PROGRESS');

            loadMyBookings();

            // Add session to active sessions on server
            fetch('/add_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_key: b.id, duration: b.duration })
            });

            // open experiment page in new tab with key & duration
            const url = `${PI_EXPERIMENT_URL}?key=${b.id}&duration=${b.duration}`;
            const win = window.open(url, '_blank', 'noopener');
            if (!win) alert("Popup blocked. Please allow popups for this site to open experiment in a new tab.");
        }

        // Helper to open experiment for an IN_PROGRESS booking (navigate)
        function focusExperiment(sessionKey) {
            // Check if session is still active
            const sessionStatus = localStorage.getItem('sessionStatus_' + sessionKey);
            if (sessionStatus === 'COMPLETED') {
                alert("Session has ended. Please book a new slot.");
                window.location.href = '/';
                return;
            }

            // Simply open the URL again (duration param included)
            const allBookings = JSON.parse(localStorage.getItem("bookings") || "{}");
            const user = localStorage.getItem("loggedUser");
            const list = allBookings[user] || [];
            const b = list.find(x => x.id === sessionKey);
            if (!b) { alert("Booking not found."); return; }

            const url = `${PI_EXPERIMENT_URL}?key=${b.id}&duration=${b.duration}`;
            window.location.href = url;
        }

        // Live timer updates for active sessions
        function updateLiveTimers() {
            const user = localStorage.getItem("loggedUser");
            if (!user) return;

            let bookings = JSON.parse(localStorage.getItem("bookings") || "{}");
            let list = bookings[user] || [];

            list.forEach(b => {
                if (b.status === STATUS.IN_PROGRESS) {
                    const sessionEndTime = localStorage.getItem('sessionEndTime_' + b.id);
                    if (sessionEndTime) {
                        const remainingMs = Math.max(0, parseInt(sessionEndTime) - Date.now());
                        const timerElement = document.querySelector(`[data-session-id="${b.id}"]`);
                        if (timerElement) {
                            timerElement.textContent = msToTimeShort(remainingMs);
                        }
                    }
                }
            });
        }

        // Update live timers every second for active sessions
        setInterval(updateLiveTimers, 1000);

        // Formatting helpers
        function pad(n){ return n<10?('0'+n):n; }
        function formatTimeOnly(msOrTs) {
            const d = new Date(msOrTs);
            return pad(d.getHours()) + ':' + pad(d.getMinutes());
        }
        function formatDateOnly(msOrTs) {
            const d = new Date(msOrTs);
            return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
        }
        function formatDateTimeDisplay(msOrTs) {
            const d = new Date(msOrTs);
            return formatDateOnly(msOrTs) + ' ' + formatTimeOnly(msOrTs);
        }
        function msToTimeShort(ms) {
            if (ms <= 0) return '0m 0s';
            const mins = Math.floor(ms / 60000);
            const secs = Math.floor((ms % 60000) / 1000);
            if (mins > 0) return `${mins}m ${secs}s`;
            return `${secs}s`;
        }

        // Periodic status updater (runs every 15 seconds)
        setInterval(() => {
            const user = localStorage.getItem("loggedUser");
            if (!user) return;
            let bookings = JSON.parse(localStorage.getItem("bookings") || "{}");
            let list = bookings[user] || [];
            let changed = false;
            const now = Date.now();

            list = list.map(b => {
                const prev = b.status;
                // if cancelled/completed keep
                if (b.status === STATUS.CANCELLED || b.status === STATUS.COMPLETED) return b;

                if (b.startedAt) {
                    const endAfterStart = b.startedAt + b.duration * 60 * 1000;
                    if (now > endAfterStart) {
                        b.status = STATUS.COMPLETED;
                        b.completedAt = endAfterStart;
                    } else {
                        b.status = STATUS.IN_PROGRESS;
                    }
                } else {
                    if (now < b.startMs) {
                        b.status = STATUS.UPCOMING;
                    } else if (now >= b.startMs && now <= b.endMs) {
                        b.status = STATUS.ACTIVE;
                    } else if (now > b.endMs) {
                        b.status = STATUS.EXPIRED;
                    }
                }

                if (b.status !== prev) changed = true;
                return b;
            });

            if (changed) {
                bookings[user] = list;
                localStorage.setItem("bookings", JSON.stringify(bookings));
                loadMyBookings();
            } else {
                // still refresh UI (e.g., remaining time) each 15s
                loadMyBookings();
            }
        }, 15000);

        // Initialize UI on load
        updateAuthUI();
    </script>
</body>
</html>